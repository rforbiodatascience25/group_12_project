---
title: "Different graphs"
format: html
editor: visual
---

## Running Code

#### Loading libraries:

```{r}

library(dplyr)
library(ggplot2)
library(scales)
```

#### Read data:

```{r}

dat <- read.delim("../data/03_dat_aug.tsv")
```

#### Re-ordering

Ordering the different genotypes into groups from the augmented data:

```{r}

# Create ER/PR/HER2 combo groups
dat <- dat |>
  mutate(
    ER   = if_else(er_status  == "P", "ER+",  "ER-"),
    PR   = if_else(pr_status  == "P", "PR+",  "PR-"),
    HER2 = if_else(her2_status == "P", "HER2+","HER2-"),
    combo = paste(ER, PR, HER2, sep = ", ")
  ) |>
  mutate(
    combo = factor(
      combo,
      levels = c(
        "ER+, PR-, HER2-",
        "ER+, PR+, HER2-",
        "ER+, PR-, HER2+",
        "ER+, PR+, HER2+",
        "ER-, PR+, HER2-",
        "ER-, PR+, HER2+",
        "ER-, PR-, HER2+",
        "ER-, PR-, HER2-"
      )
    )
  )

# check: how many rows total?
nrow(dat)

# check: how many patients in each genotype?
dat |> count(combo)
```

#### **Graph 1:**

##### **Response (pCR vs RD) by ER/PR/HER2 Gentypes**

**pCR** = **pathological complete response,** meaning no residual invasive cancer found in the breast or lymph nodes at the time of surgery, It means the treatment eliminated all detectable invasive tumor. This is a strong **positive** prognostic indicator.

**RD = residual disease, meaning** invasive tumor remains in the breast and/or lymph nodes after treatment. It means the cancer did not completely respond to treatment. Indicates relative treatment resistance. RD is considered a **non-responder** outcome.

```{r}

# total number of patients
N_total <- nrow(dat)

# Count N per genotype (combo) group
group_counts_resp <- dat |>
  group_by(combo) |>
  summarise(N_group = n(), .groups = "drop")

ggplot(dat, aes(x = combo, fill = response)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = percent_format()) +
  # show all 8 levels even if some are empty
  scale_x_discrete(drop = FALSE) +
  
  # Add N labels above each bar
  geom_text(
    data = group_counts_resp,
    aes(
      x = combo,
      y = 1.05,
      label = paste0("N=", N_group)
    ),
    size = 3,
    inherit.aes = FALSE
  ) +
  
  labs(
    title = "Response (pCR=good vs RD=bad) by ER/PR/HER2 Genotypes",
    x = "ER/PR/HER2 Genotypes",
    y = paste0("Proportion of Patients (N = ", N_total, ")"),
    fill = "Response"
  ) +
  theme_minimal() +
  theme(
    axis.text.x  = element_text(angle = 45, hjust = 1, size = 8),
    plot.title   = element_text(size = 9.5),
    axis.title.y = element_text(size = 8),
    axis.title.x = element_text(size = 8)
  ) +
  coord_cartesian(ylim = c(0, 1.15))
```

##### **Conclusions:**

Estrogen receptor-positive breast cancer patients have a worse treatment response (Graph 1).

#### **Graph 2:**

##### Tumor Grade (1–3) by ER/PR/HER2 Combination

```{r}

# Prepare data with grade as factor (1,2,3,NA)
dat_grade <- dat |>
  mutate(
    grade = as.character(grade),
    grade = if_else(is.na(grade), "NA", grade),
    grade = factor(grade, levels = c("1", "2", "3", "NA"))
  )

# total N (same as before, but explicit)
N_total_grade <- nrow(dat_grade)

# N per genotype
group_counts_grade <- dat_grade |>
  group_by(combo) |>
  summarise(N_group = n(), .groups = "drop")

ggplot(dat_grade, aes(x = combo, fill = grade)) +
  geom_bar(position = "fill") +
  scale_x_discrete(drop = FALSE) +
  
  # Red colour scheme + grey for NA
  scale_fill_manual(
    values = c(
      "1" = "#FFCCCC",  # very light red
      "2" = "#FF6666",  # medium red
      "3" = "#CC0000",  # dark red
      "NA" = "grey80"   # NA grey
    ),
    drop = FALSE,
    name = "Grade"
  ) +
  
  scale_y_continuous(labels = percent_format()) +
  
  # N labels above bars
  geom_text(
    data = group_counts_grade,
    aes(
      x = combo,
      y = 1.05,
      label = paste0("N=", N_group)
    ),
    size = 3,
    inherit.aes = FALSE
  ) +
  
  labs(
    title = "Tumor Grade (1–3) by ER/PR/HER2 Genotypes",
    x = "ER/PR/HER2 Genotypes",
    y = paste0("Proportion of Patients (N = ", N_total_grade, ")"),
    fill = "Grade"
  ) +
  theme_minimal() +
  theme(
    axis.text.x  = element_text(angle = 45, hjust = 1, size = 8),
    plot.title   = element_text(size = 10),
    axis.title.y = element_text(size = 8),
    axis.title.x = element_text(size = 8)
  ) +
  coord_cartesian(ylim = c(0, 1.15))

```

##### **Conclusions:**

Even tough being postitive for Estrogen receptors do have the worst outcome (Graph 1), they do not have a more agressive tumor grade (Graph 2). Being negative for both hormone receptors leads to a more aggressive tumor grade (Graph 2), and those two actually had the worst outcome (Graph 1).

#### Graph 3:

##### **Prepare for heatmap plot to look at the tumor size (0-4) among genotypes:**

```{r}

# 1. Make a clean tumor-size variable with NA as category
dat_ts <- dat |>
  mutate(
    ts = ifelse(is.na(tumor_size_before),
                "NA",
                as.character(tumor_size_before))
  )

# all genotype levels (from your combo factor) and all tumor-size levels
all_combos <- levels(dat$combo)
ts_levels  <- c("0", "1", "2", "3", "4", "NA")    

# 2. Create full grid: every combo × every tumor-size level
full_grid_ts <- expand.grid(
  combo = all_combos,
  ts    = ts_levels,
  stringsAsFactors = FALSE
)

# 3. Summary: counts & percentages per combo × tumor size
ts_summary <- full_grid_ts %>%
  left_join(
    dat_ts %>% count(combo, ts),
    by = c("combo", "ts")
  ) %>%
  mutate(
    n = ifelse(is.na(n), 0, n)
  ) %>%
  group_by(combo) %>%
  mutate(
    total = sum(n),
    pct   = ifelse(total > 0, n / total, 0)
  ) %>%
  ungroup()

# factor for tumor size (plot rows)
ts_summary$ts <- factor(ts_summary$ts, levels = ts_levels)

# 4. N per combo (for labels) 
group_counts_ts <- ts_summary |>
  distinct(combo, total) |>
  rename(N_group = total)

# 5. Extended factor for plotting: add an extra row "N" under 0
ts_levels_with_N <- c(ts_levels, "N")   # extra level at bottom just for labels

ts_summary <- ts_summary |>
  mutate(
    ts_plot = factor(as.character(ts), levels = ts_levels_with_N)
  )

n_label_df <- group_counts_ts |>
  mutate(
    ts_plot = factor("N", levels = ts_levels_with_N)
  )
```

##### **Graph - Heatmap plot -** Tumor Size Before Treatment by ER/PR/HER2 Genotypes

```{r}

ggplot() +
  # heatmap tiles
  geom_tile(
    data = ts_summary,
    aes(x = combo, y = ts_plot, fill = pct),
    color = "white"
  ) +

  # percentage labels inside tiles
  geom_text(
    data = ts_summary,
    aes(x = combo, y = ts_plot, label = paste0(round(pct * 100), "%")),
    size = 3
  ) +

  # N labels in their own row under the heatmap
  geom_text(
    data = n_label_df,
    aes(x = combo, y = ts_plot, label = paste0("N=", N_group)),
    size = 3
  ) +

  scale_fill_gradient(
    low   = "#FFEEEE",
    high  = "#990000",
    labels = percent_format(accuracy = 1),
    name  = "Proportion"
  ) +

  # keep all genotypes, even if some have few patients
  scale_x_discrete(drop = FALSE) +

  # y labels: hide label for the extra "N" row
  scale_y_discrete(
    breaks = ts_levels_with_N,
    labels = c("0", "1", "2", "3", "4", "NA", "")   # last "" hides N tick label
  ) +

  labs(
    title = "Tumor Size Before Treatment by ER/PR/HER2 Genotypes",
    x     = "ER/PR/HER2 Genotypes",
    y     = "Tumor size before surgery"
  ) +

  theme_minimal() +
  theme(
    axis.text.x  = element_text(angle = 45, hjust = 1, size = 8),
    plot.title   = element_text(size = 10),
    axis.title.x = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    legend.title = element_text(size = 8),
    legend.text  = element_text(size = 8)
  )
```

##### Conclusion:

Far most of the genotype groups have a size 2 tumor stage, or otherwise they have developed into size 3-4. This is especially the case for groups that are Estrogen receptor positive, and the last two groups which are negative for both hormone receptors.

#### Graph 4:

##### **Prepare for bubble plot to look at the lymph nodes among genotype groups:**

```{r}

# 1. Clean node categories (0–3 + NA)
dat_nodes <- dat |>
  mutate(
    nodes_cat = if_else(
      is.na(nodes_before),
      "NA",
      as.character(nodes_before)
    )
  )

# 2. Summarise counts and percentages per combo × node category
nodes_summary <- dat_nodes |>
  count(combo, nodes_cat, name = "n") |>
  group_by(combo) |>
  mutate(
    total = sum(n),
    pct   = n / total
  ) |>
  ungroup()

# 3. N per combo (for labels)
group_counts_nodes <- nodes_summary |>
  distinct(combo, total) |>
  rename(N_group = total)

# 4. Y-axis levels for plotting:
#    bottom → top: 3, 2, 1, 0, NA, N(row for labels)
y_levels <- c("0", "1", "2", "3", "NA", "N")

# Add plotting factor for nodes
nodes_summary <- nodes_summary |>
  mutate(
    nodes_y = factor(nodes_cat, levels = y_levels)
  )

# Data frame for N labels row
n_label_df <- group_counts_nodes |>
  mutate(
    nodes_y = factor("N", levels = y_levels)
  )

head(nodes_summary)
group_counts_nodes
```

##### **Graph - Bubble plot - Lymph Node Status Before Treatment by ER/PR/HER2 Genotypes**

```{r}

ggplot() +
  # Bubbles: size & colour = percentage
  geom_point(
    data = nodes_summary,
    aes(x = combo, y = nodes_y, size = pct, colour = pct),
    alpha = 0.9
  ) +

  # N labels in their own row ABOVE NA
  geom_text(
    data = n_label_df,
    aes(x = combo, y = nodes_y, label = paste0("N=", N_group)),
    size = 3,
    ) +

  # bubble size = percentage (hide legend)
  scale_size(
    range  = c(3, 10),
    labels = percent_format(accuracy = 1),
    guide  = "none"
  ) +

  # bubble colour = percentage (red gradient)
  scale_colour_gradient(
    low    = "#FFEEEE",
    high   = "#990000",
    labels = percent_format(accuracy = 1),
    name   = "Proportion"
  ) +

  # keep all 8 genotype groups
  scale_x_discrete(drop = FALSE) +

  # y labels: from TOP → BOTTOM = NA, 3, 2, 1, 0
  scale_y_discrete(
    limits = y_levels,
    labels = c("0", "1", "2", "3", "NA", "")   # bottom→top; top tick "" hides N
  ) +

  labs(
    title = "Lymph Node Status Before Treatment by ER/PR/HER2 Genotypes",
    x     = "ER/PR/HER2 Genotypes",
    y     = "Nodes before surgery"
  ) +

coord_cartesian(ylim = c(0.2, length(y_levels) + 0.7)) +
  
  theme_minimal() +
  theme(
    axis.text.x  = element_text(angle = 45, hjust = 1, size = 8),
    plot.title   = element_text(size = 9),
    axis.title.x = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    legend.title = element_text(size = 8),
    legend.text  = element_text(size = 8)
  )

```

##### Conclusion:

Generally it seems to be worst to have these three genotypes:

ER+, PR-, HER2-\
ER-PR-, HER+2\
ER-, PR-, HER2- (triple negative)

As they have more affected lymph nodes.

#### **Graph 5:**

##### **Prep: treatment among genotypes**

```{r}

# Clean treatment variable
dat_treat <- dat |>
  mutate(
    treatment = as.character(treatment),
    treatment = if_else(is.na(treatment), "NA", treatment)
  )

# Summarise: count + proportions per genotype × treatment
treat_summary <- dat_treat |>
  group_by(combo, treatment) |>
  summarise(n = n(), .groups = "drop") |>
  group_by(combo) |>
  mutate(
    total = sum(n),
    pct   = n / total
  ) |>
  ungroup()

# Keep the same genotype order you already defined
treat_summary$combo <- factor(
  treat_summary$combo,
  levels = levels(dat$combo)
)
```

##### **Graph - Treatment among genotypes**

```{r}

treatment_colors <- c(
  "FAC"        = "#FF9999",
  "FACT"       = "#E69F00",
  "FACT+XRT/X" = "#B8860B",
  "FEC"        = "#66A61E",
  "FECT"       = "#1B9E77",
  "NA"         = "grey70",  
  "TFAC"       = "#00A6D6",
  "TFAC/HT"    = "#56B4E9",
  "TFEC"       = "#0072B2",
  "TH/FAC"     = "#7570B3",
  "TH/FEC"     = "#CC79A7",
  "Tonly"      = "#F0027F",
  "TXFAC"      = "#E7298A"
)

ggplot(treat_summary, aes(x = combo, y = pct, fill = treatment)) +
  
  # N labels above bars 
  geom_text(
    data = group_counts_treat,
    aes(
      x = combo,
      y = 1.07,                     
      label = paste0("N=", N_group)
    ),
    size = 3,
    inherit.aes = FALSE
  ) +
  
  # Stacked bars
  geom_col(position = "fill") +
  
  # Percent labels
  geom_text(
    aes(
      label = ifelse(pct > 0.02, paste0(round(pct * 100), "%"), "")
    ),
    position = position_fill(vjust = 0.5),
    size = 2.5,
    color = "black",
  ) +
  
  # Apply grey for NA + colors for other treatments
  scale_fill_manual(values = treatment_colors, drop = FALSE) +

  scale_x_discrete(drop = FALSE) +
  scale_y_continuous(labels = percent_format()) +

  labs(
    title = "Treatment Distribution Across ER/PR/HER2 Genotypes",
    x = "ER/PR/HER2 Genotype",
    y = "Proportion of Patients",
    fill = "Treatment"
  ) +
  
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 20, hjust = 1, size = 7),
    plot.title  = element_text(size = 10),
    axis.title  = element_text(size = 9),

    legend.position = "bottom",
    legend.title = element_text(size = 7),
    legend.text  = element_text(size = 6),

    legend.box       = "horizontal",
    legend.box.spacing = unit(0.2, "lines"),
    legend.key.size  = unit(3.5, "mm"),
    legend.key.width = unit(3.5, "mm"),
    legend.spacing.x = unit(0.5, "mm"),
    legend.spacing.y = unit(0.2, "mm")
  ) +
  
  guides(
    fill = guide_legend(
      ncol = 7,
      byrow = TRUE,
      title.position = "top"
    )
  ) +
  
  coord_cartesian(ylim = c(0, 1.15))
```

##### Conclusion:

Generally, more different treatments were tried in the last two groups, especially for the second last group, which also had the best response. The second group from the left (ER+, PR+, HER2-) also had more treatments but showed a bad response. So in conclusion, (1) more personalized treatment options give better response, (2) and a general broad TFAC and TFEC is not working for estrogen-positive patients.

Aggressiveness, tumor size, and nodes do not necessarily mean a bad outcome. With personalized treatments, it can mean good results for the patient even if the stage or grade of the tumor seems to have a theoretically bad prognosis.
