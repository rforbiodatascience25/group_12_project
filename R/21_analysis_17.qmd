---
title: "21_analysis_17"
format: html
editor: visual
---

## Running Code

#### Loading libraries:

```{r}
#| message: false
library("here")
library("tidyverse")
```

#### Read data:

```{r}
#| message: false
dataset <- read_tsv(file = here("data/03_dat_aug.tsv"))
```

#### Re-ordering

Ordering the different genotypes into groups from the augmented data:

```{r}
# Create ER/PR/HER2 combo groups
dataset <- dataset |>
  mutate(
    ER = if_else(
      er_status == "P", 
      "ER+",
      "ER-"),
    PR = if_else(
      pr_status == "P",
      "PR+", 
      "PR-"),
    HER2 = if_else(
      her2_status == "P",
      "HER2+",
      "HER2-"),
    combo = paste(
      ER,
      PR,
      HER2,
      sep = ", ")) |>
  mutate(
    combo = factor(
      combo,
      levels = c(
        "ER+, PR-, HER2-",
        "ER+, PR+, HER2-",
        "ER+, PR-, HER2+",
        "ER+, PR+, HER2+",
        "ER-, PR+, HER2-",
        "ER-, PR+, HER2+",
        "ER-, PR-, HER2+",
        "ER-, PR-, HER2-")))

# check: how many rows total?
nrow(dataset)

# check: how many patients in each genotype?
dataset |> 
  count(combo)
```

#### Graph 4:

##### **Prepare for a bubble plot to look at the lymph nodes among genotype groups:**

```{r}

# 1. Clean node categories (0–3 + NA)
dat_nodes <- dataset |>
  mutate(
    nodes_cat = if_else(
      is.na(nodes_before),
      "NA",
      as.character(nodes_before)))

# 2. Summarise counts and percentages per combo × node category
nodes_summary <- dat_nodes |>
  count(combo, 
        nodes_cat,
        name = "n") |>
  group_by(combo) |>
  mutate(
    total = sum(n),
    pct   = n / total) |>
  ungroup()

# 3. N per combo (for labels)
group_counts_nodes <- nodes_summary |>
  distinct(combo,
           total) |>
  rename(N_group = total)

# 4. Y-axis levels for plotting:
#    bottom → top: 3, 2, 1, 0, NA, N(row for labels)
y_levels <- c("0", "1", "2", "3", "NA", "N")

# Add plotting factor for nodes
nodes_summary <- nodes_summary |>
  mutate(
    nodes_y = factor(
      nodes_cat,
      levels = y_levels))

# Data frame for N labels row
n_label_df <- group_counts_nodes |>
  mutate(
    nodes_y = factor(
      "N", 
      levels = y_levels))

head(nodes_summary)
group_counts_nodes
```

##### **Graph - Bubble plot - Lymph Node Status Before Treatment by ER/PR/HER2 Genotypes**

```{r}
gg_17 <- ggplot() +
  # Bubbles: size & colour = percentage
  geom_point(
    data = nodes_summary,
    aes(
      x = combo,
      y = nodes_y,
      size = pct, 
      colour = pct),
    alpha = 0.9) +

  # N labels in their own row ABOVE NA
  geom_text(
    data = n_label_df,
    aes(
      x = combo,
      y = nodes_y,
      label = paste0("N=", N_group)),
    size = 3,) +

  # bubble size = percentage (hide legend)
  scale_size(
    range  = c(3, 10),
    labels = percent_format(accuracy = 1),
    guide  = "none") +

  # bubble colour = percentage (red gradient)
  scale_colour_gradient(
    low    = "#e2619f",
    high   = "#90C84C",
    labels = percent_format(accuracy = 1),
    name   = "Proportion") +

  # keep all 8 genotype groups
  scale_x_discrete(drop = FALSE) +

  # y labels: from TOP to BOTTOM = NA, 3, 2, 1, 0; "" hides N
  scale_y_discrete(
    limits = y_levels,
    labels = c("0", "1", "2", "3", "NA", "")) +

  labs(
    title = "Lymph Node Status Before Treatment by ER/PR/HER2 Genotypes",
    x     = "ER/PR/HER2 Genotypes",
    y     = "Nodes before surgery") +
  coord_cartesian(ylim = c(0.2,
                           length(y_levels) + 0.7)) +
  theme_minimal() +
  theme(axis.text.x  = element_text(angle = 45,
                                    hjust = 0.8,
                                    size = 8),
        plot.title   = element_text(hjust = 0.5),
        axis.title.x = element_text(vjust = 0))

gg_17
```

```{r}
ggsave(gg_17, 
       filename = "21_key_plot_17.png",
       device = "png")
```

##### Conclusion:

Generally it seems to be worst to have these three genotypes:

ER+, PR-, HER2-\
ER-PR-, HER+2\
ER-, PR-, HER2- (triple negative)

As they have more affected lymph nodes.
