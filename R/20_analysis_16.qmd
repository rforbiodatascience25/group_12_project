---
title: "20_analysis_16"
format: html
editor: visual
---

## Running Code

#### Loading libraries:

```{r}

library("dplyr")   
library("ggplot2")   
library("scales")
```

#### Read data:

```{r}

dat <- read.delim("../data/03_dat_aug.tsv")
```

#### Re-ordering

Ordering the different genotypes into groups from the augmented data:

```{r}

# Create ER/PR/HER2 combo groups
dat <- dat |>
  mutate(
    ER   = if_else(er_status  == "P",
                   "ER+",
                   "ER-"),
    PR   = if_else(pr_status  == "P",
                   "PR+",
                   "PR-"),
    HER2 = if_else(her2_status == "P",
                   "HER2+",
                   "HER2-"),
    combo = paste(ER,
                  PR, 
                  HER2,
                  sep = ", ")
  ) |>
  mutate(
    combo = factor(
      combo,
      levels = c(
        "ER+, PR-, HER2-",
        "ER+, PR+, HER2-",
        "ER+, PR-, HER2+",
        "ER+, PR+, HER2+",
        "ER-, PR+, HER2-",
        "ER-, PR+, HER2+",
        "ER-, PR-, HER2+",
        "ER-, PR-, HER2-"
      )
    )
  )

# check: how many rows total?
nrow(dat)

# check: how many patients in each genotype?
dat |> count(combo)
```

#### Graph 3:

##### **Prepare for heatmap plot to look at the tumor size (0-4) among genotypes:**

```{r}

# 1. Make a clean tumor-size variable with NA as category
dat_ts <- dat |>
  mutate(
    ts = ifelse(is.na(tumor_size_before),
                "NA",
                as.character(tumor_size_before))
  )

# all genotype levels (from your combo factor) and all tumor-size levels
all_combos <- levels(dat$combo)
ts_levels  <- c("0", "1", "2", "3", "4", "NA")    

# 2. Create full grid: every combo × every tumor-size level
full_grid_ts <- 
  expand.grid(
    combo = all_combos,
    ts    = ts_levels,
    stringsAsFactors = FALSE
    )

# 3. Summary: counts & percentages per combo × tumor size
ts_summary <- 
  full_grid_ts %>%
  left_join(
    dat_ts %>% count(combo, ts),
    by = c("combo", "ts")
  ) %>%
  mutate(
    n = ifelse(is.na(n),
               0,
               n)
  ) %>%
  group_by(combo) %>%
  mutate(
    total = sum(n),
    pct   = ifelse(total > 0,
                   n / total,
                   0)
  ) %>%
  ungroup()

# factor for tumor size (plot rows)
ts_summary$ts <- factor(ts_summary$ts,
                        levels = ts_levels)

# 4. N per combo (for labels) 
group_counts_ts <- 
  ts_summary |>
  distinct(combo,
           total) |>
  rename(N_group = total)

# 5. Extended factor for plotting: add an extra row "N" under 0
ts_levels_with_N <- c(ts_levels, "N")   # extra level at bottom just for labels

ts_summary <- ts_summary |>
  mutate(
    ts_plot = factor(as.character(ts),
                     levels = ts_levels_with_N)
  )

n_label_df <- group_counts_ts |>
  mutate(
    ts_plot = factor("N",
                     levels = ts_levels_with_N)
  )
```

##### **Graph - Heatmap plot -** Tumor Size Before Treatment by ER/PR/HER2 Genotypes

```{r}

ggplot() +
  # heatmap tiles
  geom_tile(
    data = ts_summary,
    aes(
      x = combo,
      y = ts_plot,
      fill = pct),
    color = "white"
  ) +

  # percentage labels inside tiles
  geom_text(
    data = ts_summary,
    aes(
      x = combo,
      y = ts_plot,
      label = paste0(round(pct * 100), "%")),
    size = 3
  ) +

  # N labels in their own row under the heatmap
  geom_text(
    data = n_label_df,
    aes(
      x = combo,
      y = ts_plot,
      label = paste0("N=", N_group)),
    size = 3
  ) +
  
  scale_fill_gradient(
    low   = "#FFEEEE",
    high  = "#990000",
    labels = percent_format(accuracy = 1),
    name  = "Proportion"
  ) +

  # keep all genotypes, even if some have few patients
  scale_x_discrete(drop = FALSE) +

  # y labels: hide label for the extra "N" row
  scale_y_discrete(
    breaks = ts_levels_with_N,
    labels = c("0", "1", "2", "3", "4", "NA", "")   # last "" hides N tick label
  ) +

  labs(
    title = "Tumor Size Before Treatment by ER/PR/HER2 Genotypes",
    x     = "ER/PR/HER2 Genotypes",
    y     = "Tumor size before surgery"
  ) +
  theme_minimal() +
  theme(
    axis.text.x  = element_text(angle = 45, 
                                hjust = 1, 
                                size = 8),
    plot.title   = element_text(size = 10),
    axis.title.x = element_text(size = 8),
    axis.title.y = element_text(size = 8),
    legend.title = element_text(size = 8),
    legend.text  = element_text(size = 8)
  )
```

##### Conclusion:

Far most of the genotype groups have a size 2 tumor stage, or otherwise they have developed into size 3-4. This is especially the case for groups that are Estrogen receptor positive, and the last two groups which are negative for both hormone receptors.
