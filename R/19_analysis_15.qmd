---
title: "19_analysis_15"
format: 
  html:
    self-contained: true
editor: visual
---

## Running Code

#### Loading libraries:

```{r}
#| message: false
library("here")
library("tidyverse")
library("scales")
```

#### Read data:

```{r}
#| message: false
dataset <- read_tsv(file = here("data/03_dat_aug.tsv"))
```

#### Re-ordering

Ordering the different genotypes into groups from the augmented data:

```{r}

# Create ER/PR/HER2 combo groups
dataset <- dataset |>
  mutate(
    ER = if_else(
      er_status == "P",
      "ER+",
      "ER-"),
    PR = if_else(
      pr_status == "P", 
      "PR+", 
      "PR-"),
    HER2 = if_else(
      her2_status == "P",
      "HER2+",
      "HER2-"),
    combo = paste(
      ER, 
      PR,
      HER2,
      sep = ", ")) |>
  mutate(
    combo = factor(
      combo,
      levels = c(
        "ER+, PR-, HER2-",
        "ER+, PR+, HER2-",
        "ER+, PR-, HER2+",
        "ER+, PR+, HER2+",
        "ER-, PR+, HER2-",
        "ER-, PR+, HER2+",
        "ER-, PR-, HER2+",
        "ER-, PR-, HER2-")))

# check: how many rows total?
nrow(dataset)

# check: how many patients in each genotype?
dataset |> 
  count(combo)
```

#### **Graph 2:**

##### Tumor Grade (1–3) by ER/PR/HER2 Genotypes

```{r}

# Prepare data with grade as factor (1,2,3,NA)
dat_grade <- dataset |>
  mutate(
    grade = as.character(grade),
    grade = if_else(is.na(grade),
                    "NA",
                    grade),
    grade = factor(grade,
                   levels = c("1", "2", "3", "NA")))

# total N (same as before, but explicit)
N_total_grade <- nrow(dat_grade)

# N per genotype
group_counts_grade <- dat_grade |>
  group_by(combo) |>
  summarise(N_group = n(),
            .groups = "drop")

custom_palette <- c("#e44b8d",
                    "lightblue",
                    "#90C84C",
                    "gray")

gg_15 <- ggplot(
  dat_grade,
  aes(
    x = combo,
    fill = grade)) +
  geom_bar(position = "fill") +
  scale_x_discrete(drop = FALSE) +
  scale_y_continuous(labels = percent_format()) +
  
  # N labels above bars
  geom_text(
    data = group_counts_grade,
    aes(
      x = combo,
      y = 1.05,
      label = paste0("N=",
                     N_group)),
    size = 3,
    inherit.aes = FALSE) +
  labs(
    title = "Tumor Grade (1–3) by ER/PR/HER2 Genotypes",
    x = "ER/PR/HER2 Genotypes",
    y = paste0("Proportion of Patients (N = ", N_total_grade, ")"),
    fill = "Grade") +
  scale_fill_manual(values = custom_palette) +
  theme_minimal() +
  theme(axis.text.x  = element_text(angle = 45,
                                    hjust = 1,
                                    size = 8),
        plot.title   = element_text(hjust = 0.5),
        axis.title.x = element_text(vjust = 0)) +
  coord_cartesian(ylim = c(0, 1.1))

gg_15
```

```{r}
ggsave(gg_15, 
       filename = "19_key_plot_15.png",
       path = here("./results"),
       device = "png",
       height = 5,
       width = 8)
```

##### **Conclusions:**

Even tough being postitive for Estrogen receptors do have the worst outcome (Graph 1), they do not have a more agressive tumor grade (Graph 2). Being negative for both hormone receptors leads to a more aggressive tumor grade (Graph 2), and those two actually had the worst outcome (Graph 1).
